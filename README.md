# common_system_users
Конфигурация и CI для деплоя юзеров (и их удаления) из ансиблоых плейбуков на наши продовые, инфровые и тестовые хосты.
Механизмы взаимодействия:

1) Пайплайн (stage: lint через ansible-lint и deploy через ansible-playbook) создаётся после push-коммита из мастер-ветки (lint поождаётся из любой ветки).
Такой механизм деплоя не лимитируется, выкатываются все инвентори.

2) Для использования механизма лимитирования следует создать пайплайн из "Run pipeline" из веб-интерфейса гитлаба. При этом нужно задать переменную "LIMITS" и в значении перечислить необходимые лимиты.

## Инвентори  
hosts.yaml - файл инвентори, содержащий набор необходимых переменных и список всех хостов.

### Списки юзеров  
1) Юзеры, имеющие state present, представлены в списках ansible_deploy_user (сам ansible-user, которого нужно выкатывать руками, если ansible-user'а нет на хосте), default_gp_ssh_users, default_cam_ssh_users, vgk_ssh_users, inf_ops_ssh_users, duty_ops_ssh_users.  
2) Юзеры, имеющие state absent, представлены в отдельном списке absent_ssh_users.  
Такое разделение имеет важное значение, т.к. по этим группам юзеров выполняются таски create и delete users.

### Список users для тасков create users  
1) "По дефолту" используется список ssh_users, остоящий из всех групп юзеров, описанных в пред. пункте.  
2) Кроме того, есть список default_with_ansible (те же юзеры + ansible-user, если требуется выкатить юзера ansible руками), devops_and_infra_ops (девопс + ДИТ без ДА).  
Эти группы можно указыть в vars для групп хостов, если эти необходимо.

### Принципы создания групп хостов  
1) Основные переменные, которые могут потребоваться: ansible_host (ip для ssh-подключения к хосту), ansible_port (порт ssh-подключения), proxy_host (хост для proxy jump).  
2) При создании инвентории главная цель была в минимизации дублирования хостов при описании, по этой причине инвентори организован так, что:  
2.1.) На самом верхнем уровне vars (all) задаются хосты, которые являются проксирующими для остальных хостов (qa-nginx, ek_parking_anyconnect и т.д.).  
2.2.) Если ansible_host, proxy_host или ansible_port нужен для нескольких хостов группы, то этот хост указывается в vars на уровне группы, например, как это сделано для Белгород АИС:  
```
bel_ais:
    vars:
        ansible_host: 172.21.0.1
    hosts:
    bel_k8s_node1:
        ansible_port: 2201
    bel_k8s_node2:
        ansible_port: 2202
    bel_k8s_node3:
        ansible_port: 2203
```
